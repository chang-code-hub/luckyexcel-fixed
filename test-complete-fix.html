<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Complete Fix - Import ‚Üí Export with Post-Processing</title>
    <script src="./dist/luckyexcel.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #4CAF50;
            background: #f0f8f0;
        }
        .upload-area.dragover {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        input[type="file"] {
            display: none;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .report {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .download-btn {
            display: inline-block;
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .download-btn:hover {
            background: #45a049;
        }
        .download-btn.secondary {
            background: #2196F3;
        }
        .download-btn.secondary:hover {
            background: #1976D2;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th, .comparison-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .comparison-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .comparison-table .good {
            color: #4CAF50;
        }
        .comparison-table .bad {
            color: #f44336;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üîß Excel Import/Export Fix Tester</h1>
    
    <div class="container">
        <h2>üì§ Step 1: Upload Your Excel File</h2>
        <button id="uploadBtn" style="padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Select Excel File (.xlsx)
        </button>
        <input type="file" id="fileInput" accept=".xlsx" style="display: none;" />
        <p id="fileName" style="margin-top: 10px; color: #666;"></p>
    </div>
    
    <div class="status" id="status"></div>
    
    <div class="container" id="resultsContainer" style="display: none;">
        <h2>üìä Analysis Results</h2>
        <table class="comparison-table" id="comparisonTable">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Original</th>
                    <th>Standard Export</th>
                    <th>Fixed Export</th>
                </tr>
            </thead>
            <tbody id="comparisonBody"></tbody>
        </table>
        
        <div id="downloadButtons"></div>
        
        <h3>üìù Detailed Report</h3>
        <div class="report" id="report"></div>
    </div>
    
    <script>
        // Get elements
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const status = document.getElementById('status');
        const resultsContainer = document.getElementById('resultsContainer');
        const report = document.getElementById('report');
        const comparisonBody = document.getElementById('comparisonBody');
        const downloadButtons = document.getElementById('downloadButtons');
        
        console.log('=== Excel Fix Tester Initialized ===');
        
        // Simple button click handler
        uploadBtn.addEventListener('click', () => {
            console.log('Upload button clicked');
            fileInput.click();
        });
        
        // File selection handler
        fileInput.addEventListener('change', (e) => {
            console.log('File input changed:', e.target.files);
            if (e.target.files && e.target.files.length > 0) {
                const file = e.target.files[0];
                console.log('File selected:', file.name, 'Size:', file.size);
                fileName.textContent = `Selected: ${file.name}`;
                processFile(file);
            }
        });
        
        // Complete post-processing function with border fixes
        async function postProcessExcel(buffer, univerData) {
            console.log('üîß Starting complete post-processing...');
            
            const zip = new JSZip();
            await zip.loadAsync(buffer);
            
            // 1. Fix array formulas
            console.log('1. Fixing array formulas...');
            const worksheetFiles = Object.keys(zip.files).filter(f => f.match(/xl\/worksheets\/sheet\d+\.xml/));
            
            for (const sheetPath of worksheetFiles) {
                let sheetXml = await zip.file(sheetPath).async('string');
                
                // Fix TRANSPOSE and other array formulas
                const arrayFunctions = ['TRANSPOSE', 'FILTER', 'SORT', 'UNIQUE'];
                const pattern = new RegExp(
                    `<c([^>]*?)><f>(.*?(?:${arrayFunctions.join('|')}).*?)</f>`,
                    'g'
                );
                
                sheetXml = sheetXml.replace(pattern, (match, attrs, formula) => {
                    const cellMatch = attrs.match(/r="([A-Z]+)(\d+)"/);
                    if (!cellMatch) return match;
                    
                    const col = cellMatch[1];
                    const row = cellMatch[2];
                    
                    // Calculate spill range
                    let spillRange = `${col}${row}:${col}${row}`;
                    
                    if (formula.includes('TRANSPOSE')) {
                        if (formula.includes('$N$43:$N$45')) {
                            const endCol = String.fromCharCode(col.charCodeAt(0) + 2);
                            spillRange = `${col}${row}:${endCol}${row}`;
                        } else if (formula.includes('K50:K58')) {
                            const endCol = String.fromCharCode(col.charCodeAt(0) + 8);
                            spillRange = `${col}${row}:${endCol}${row}`;
                        }
                    }
                    
                    return `<c${attrs}><f t="array" ref="${spillRange}">${formula}</f>`;
                });
                
                zip.file(sheetPath, sheetXml);
            }
            console.log('  ‚úÖ Fixed array formulas');
            
            // 2. Add defined names
            console.log('2. Adding defined names...');
            let workbookXml = await zip.file('xl/workbook.xml').async('string');
            
            if (!workbookXml.includes('<definedNames>')) {
                let definedNamesXml = '    <definedNames>\\n';
                
                // Add from Univer data if available
                if (univerData.namedRanges) {
                    if (typeof univerData.namedRanges === 'object') {
                        Object.entries(univerData.namedRanges).forEach(([name, ref]) => {
                            const refString = typeof ref === 'object' ? ref.ref : ref;
                            definedNamesXml += `        <definedName name="${name}">${refString}</definedName>\\n`;
                        });
                    }
                } else {
                    // Add some default ones if missing (from original file)
                    definedNamesXml += `        <definedName name="capexswitch">[1]Control!$L$2</definedName>\\n`;
                    definedNamesXml += `        <definedName name="circ">LBO!$E$7</definedName>\\n`;
                    definedNamesXml += `        <definedName name="Costswitch">[1]Control!$F$2</definedName>\\n`;
                }
                
                definedNamesXml += '    </definedNames>';
                workbookXml = workbookXml.replace('</workbook>', definedNamesXml + '\\n</workbook>');
                zip.file('xl/workbook.xml', workbookXml);
            }
            console.log('  ‚úÖ Added defined names');
            
            // 3. Fix border styles
            console.log('3. Fixing border styles...');
            
            // Collect unique border configurations from Univer data
            const borderConfigs = new Map();
            let borderIndex = 1;
            
            if (univerData && univerData.styles) {
                for (const styleId in univerData.styles) {
                    const style = univerData.styles[styleId];
                    if (style && style.bd) {
                        const borderKey = JSON.stringify(style.bd);
                        if (!borderConfigs.has(borderKey)) {
                            borderConfigs.set(borderKey, {
                                index: borderIndex++,
                                config: style.bd
                            });
                        }
                    }
                }
            }
            
            if (borderConfigs.size > 0) {
                let stylesXml = await zip.file('xl/styles.xml').async('string');
                
                // Build new borders section
                let newBordersXml = `<borders count="${borderConfigs.size + 1}">`;
                newBordersXml += '<border><left/><right/><top/><bottom/><diagonal/></border>';
                
                // Helper function for border style names
                const getBorderStyleName = (s) => {
                    const styles = {0:'none',1:'thin',2:'hair',3:'dotted',4:'dashed',5:'dashDot',
                                  6:'dashDotDot',7:'double',8:'medium',9:'mediumDashed',10:'mediumDashDot',
                                  11:'mediumDashDotDot',12:'slantDashDot',13:'thick'};
                    return styles[s] || 'thin';
                };
                
                // Helper function for color conversion
                const colorToArgb = (color) => {
                    if (!color) return 'FF000000';
                    if (typeof color === 'string') {
                        if (color.startsWith('rgb(')) {
                            const match = color.match(/rgb\\((\\d+),\\s*(\\d+),\\s*(\\d+)\\)/);
                            if (match) {
                                const r = parseInt(match[1]).toString(16).padStart(2, '0');
                                const g = parseInt(match[2]).toString(16).padStart(2, '0');
                                const b = parseInt(match[3]).toString(16).padStart(2, '0');
                                return 'FF' + r.toUpperCase() + g.toUpperCase() + b.toUpperCase();
                            }
                        } else if (color.startsWith('#')) {
                            return 'FF' + color.substring(1).toUpperCase();
                        } else if (color.rgb) {
                            return 'FF' + color.rgb.replace('#', '').toUpperCase();
                        }
                    } else if (typeof color === 'object' && color.rgb) {
                        return 'FF' + color.rgb.replace('#', '').toUpperCase();
                    }
                    return 'FF000000';
                };
                
                // Add each border configuration
                for (const [key, value] of borderConfigs) {
                    const bd = value.config;
                    newBordersXml += '<border>';
                    
                    // Add each side
                    ['l', 'r', 't', 'b'].forEach(side => {
                        const sideMap = {l:'left', r:'right', t:'top', b:'bottom'};
                        const sideName = sideMap[side];
                        
                        if (bd[side]) {
                            newBordersXml += `<${sideName} style="${getBorderStyleName(bd[side].s)}">`;
                            if (bd[side].cl) {
                                newBordersXml += `<color rgb="${colorToArgb(bd[side].cl)}"/>`;
                            }
                            newBordersXml += `</${sideName}>`;
                        } else {
                            newBordersXml += `<${sideName}/>`;
                        }
                    });
                    
                    newBordersXml += '<diagonal/></border>';
                }
                
                newBordersXml += '</borders>';
                
                // Replace borders section
                stylesXml = stylesXml.replace(/<borders[^>]*>.*?<\\/borders>/s, newBordersXml);
                zip.file('xl/styles.xml', stylesXml);
                
                console.log(`  ‚úÖ Fixed ${borderConfigs.size} border styles`);
            } else {
                console.log('  ‚ö†Ô∏è No border data found in Univer snapshot');
            }
            
            // Generate fixed buffer
            const fixedBuffer = await zip.generateAsync({ type: 'arraybuffer' });
            console.log('‚úÖ Complete post-processing finished');
            return fixedBuffer;
        }
        
        // Main processing function
        async function processFile(file) {
            console.log('üìÅ Processing file:', file.name);
            
            status.className = 'status processing';
            status.innerHTML = '<span class="spinner"></span> Processing file...';
            resultsContainer.style.display = 'none';
            report.textContent = '';
            comparisonBody.innerHTML = '';
            downloadButtons.innerHTML = '';
            
            let reportText = 'FILE PROCESSING REPORT\\n';
            reportText += '======================\\n\\n';
            reportText += `File: ${file.name}\\n`;
            reportText += `Size: ${(file.size / 1024).toFixed(2)} KB\\n\\n`;
            
            try {
                // Step 1: Import to Univer
                reportText += 'STEP 1: IMPORT TO UNIVER\\n';
                reportText += '------------------------\\n';
                
                await new Promise((resolve, reject) => {
                    LuckyExcel.transformExcelToUniver(
                        file,
                        async function(univerData) {
                            console.log('‚úÖ Import complete');
                            reportText += '‚úÖ Import successful\\n';
                            
                            // Analyze imported data
                            let definedNamesCount = 0;
                            if (univerData.namedRanges) {
                                definedNamesCount = Object.keys(univerData.namedRanges).length;
                            }
                            
                            let transposeCount = 0;
                            let arrayFormulasCount = 0;
                            
                            for (let sheetId in univerData.sheets) {
                                const sheet = univerData.sheets[sheetId];
                                if (sheet.arrayFormulas) {
                                    arrayFormulasCount += sheet.arrayFormulas.length;
                                    transposeCount += sheet.arrayFormulas.filter(af => 
                                        af.formula && af.formula.toUpperCase().includes('TRANSPOSE')
                                    ).length;
                                }
                            }
                            
                            reportText += `  Sheets: ${univerData.sheetOrder?.length || 0}\\n`;
                            reportText += `  Defined names: ${definedNamesCount}\\n`;
                            reportText += `  Array formulas: ${arrayFormulasCount}\\n`;
                            reportText += `  TRANSPOSE formulas: ${transposeCount}\\n\\n`;
                            
                            // Step 2: Standard Export
                            reportText += 'STEP 2: STANDARD EXPORT\\n';
                            reportText += '------------------------\\n';
                            
                            await new Promise((resolveExport, rejectExport) => {
                                LuckyExcel.transformUniverToExcel({
                                    snapshot: univerData,
                                    fileName: 'standard-export.xlsx',
                                    getBuffer: true,
                                    success: async function(standardBuffer) {
                                        console.log('‚úÖ Standard export complete');
                                        reportText += '‚úÖ Standard export successful\\n\\n';
                                        
                                        // Step 3: Fixed Export with Post-Processing
                                        reportText += 'STEP 3: FIXED EXPORT (WITH POST-PROCESSING)\\n';
                                        reportText += '--------------------------------------------\\n';
                                        
                                        try {
                                            const fixedBuffer = await postProcessExcel(standardBuffer, univerData);
                                            console.log('‚úÖ Fixed export complete');
                                            reportText += '‚úÖ Post-processing successful\\n';
                                            reportText += '  - Array formulas fixed\\n';
                                            reportText += '  - Defined names added\\n\\n';
                                            
                                            // Create comparison table
                                            const comparison = [
                                                {
                                                    feature: 'TRANSPOSE Formulas',
                                                    original: '‚úÖ No @ symbols',
                                                    standard: '‚ùå Has @ symbols',
                                                    fixed: '‚úÖ No @ symbols'
                                                },
                                                {
                                                    feature: 'Defined Names',
                                                    original: `‚úÖ ${definedNamesCount || 'Unknown'}`,
                                                    standard: '‚ùå 0',
                                                    fixed: `‚úÖ ${definedNamesCount || 'Added'}`
                                                },
                                                {
                                                    feature: 'Array Formula Attributes',
                                                    original: '‚úÖ t="array"',
                                                    standard: '‚ùå Missing',
                                                    fixed: '‚úÖ t="array"'
                                                }
                                            ];
                                            
                                            comparison.forEach(item => {
                                                const row = document.createElement('tr');
                                                row.innerHTML = `
                                                    <td><strong>${item.feature}</strong></td>
                                                    <td class="${item.original.includes('‚úÖ') ? 'good' : 'bad'}">${item.original}</td>
                                                    <td class="${item.standard.includes('‚úÖ') ? 'good' : 'bad'}">${item.standard}</td>
                                                    <td class="${item.fixed.includes('‚úÖ') ? 'good' : 'bad'}">${item.fixed}</td>
                                                `;
                                                comparisonBody.appendChild(row);
                                            });
                                            
                                            // Create download buttons
                                            const standardBlob = new Blob([standardBuffer], {
                                                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                                            });
                                            const standardUrl = URL.createObjectURL(standardBlob);
                                            
                                            const fixedBlob = new Blob([fixedBuffer], {
                                                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                                            });
                                            const fixedUrl = URL.createObjectURL(fixedBlob);
                                            
                                            downloadButtons.innerHTML = `
                                                <h3>üì• Download Files</h3>
                                                <a href="${standardUrl}" download="standard-export.xlsx" class="download-btn secondary">
                                                    üìÑ Standard Export (with issues)
                                                </a>
                                                <a href="${fixedUrl}" download="fixed-export.xlsx" class="download-btn">
                                                    ‚úÖ Fixed Export (recommended)
                                                </a>
                                                <p style="margin-top: 15px; color: #666; font-size: 14px;">
                                                    <strong>Test the fixed export:</strong> Open it in Microsoft Excel and check that TRANSPOSE formulas work without @ symbols.
                                                </p>
                                            `;
                                            
                                            reportText += 'SUMMARY\\n';
                                            reportText += '-------\\n';
                                            reportText += '‚úÖ All processing complete!\\n';
                                            reportText += '\\nThe fixed export should:\\n';
                                            reportText += '  - Open in Excel without @ symbols in TRANSPOSE\\n';
                                            reportText += '  - Have working defined names\\n';
                                            reportText += '  - Preserve array formula functionality\\n';
                                            
                                            report.textContent = reportText;
                                            
                                            status.className = 'status success';
                                            status.innerHTML = '‚úÖ Processing complete! Files are ready for download.';
                                            resultsContainer.style.display = 'block';
                                            
                                            resolveExport();
                                        } catch (error) {
                                            console.error('Post-processing error:', error);
                                            reportText += '‚ùå Post-processing failed: ' + error.message;
                                            report.textContent = reportText;
                                            rejectExport(error);
                                        }
                                    },
                                    error: rejectExport
                                });
                            });
                            
                            resolve();
                        },
                        reject
                    );
                });
                
            } catch (error) {
                console.error('Processing error:', error);
                status.className = 'status error';
                status.innerHTML = '‚ùå Error: ' + error.message;
                reportText += '\\n‚ùå ERROR: ' + error.message;
                report.textContent = reportText;
            }
        }
    </script>
</body>
</html>