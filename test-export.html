<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Debug Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #output {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .formula {
            color: blue;
        }
        input[type="file"] {
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>üîç Export Debug Test</h1>
    
    <div class="container">
        <p>This test helps debug formula corruption during export. Upload an Excel file or use the test file from alphafrontend.</p>
        
        <input type="file" id="fileInput" accept=".xlsx">
        <button onclick="loadTestFile()">Load test.xlsx from alphafrontend</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>

    <div id="output"></div>

    <script src="dist/luckyexcel.umd.js"></script>
    <script>
        // Check if LuckyExcel loaded
        if (typeof LuckyExcel === 'undefined') {
            document.getElementById('output').innerHTML = '<div class="error">ERROR: LuckyExcel library not loaded! Make sure to run "npm run build" first.</div>';
        }
        const output = document.getElementById('output');
        let originalConsoleLog = console.log;
        let originalConsoleWarn = console.warn;
        let originalConsoleError = console.error;
        
        // Capture all console output
        function setupConsoleCapture() {
            console.log = function(...args) {
                const msg = args.join(' ');
                appendOutput(msg, 'log');
                originalConsoleLog.apply(console, args);
            };
            
            console.warn = function(...args) {
                const msg = args.join(' ');
                appendOutput(msg, 'warning');
                originalConsoleWarn.apply(console, args);
            };
            
            console.error = function(...args) {
                const msg = args.join(' ');
                appendOutput(msg, 'error');
                originalConsoleError.apply(console, args);
            };
        }
        
        function appendOutput(msg, type = 'log') {
            const line = document.createElement('div');
            
            // Apply styling based on type
            if (type === 'error' || msg.includes('Error') || msg.includes('ERROR')) {
                line.className = 'error';
            } else if (type === 'warning' || msg.includes('Warning') || msg.includes('‚ö†Ô∏è')) {
                line.className = 'warning';
            } else if (msg.includes('‚úÖ') || msg.includes('Success')) {
                line.className = 'success';
            } else if (msg.includes('[Formula]') || msg.includes('formula')) {
                line.className = 'formula';
            }
            
            line.textContent = msg;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        setupConsoleCapture();
        
        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            clearOutput();
            appendOutput('File selected: ' + e.target.files[0].name, 'log');
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            } else {
                appendOutput('No file selected!', 'error');
            }
        });
        
        // Load test file from alphafrontend
        async function loadTestFile() {
            clearOutput();
            appendOutput('üìÅ Loading test.xlsx from alphafrontend...', 'log');
            
            try {
                // Try multiple possible paths
                const paths = [
                    '../alphafrontend/docs/excel/test.xlsx',
                    '../../alphafrontend/docs/excel/test.xlsx',
                    '/Users/mertdeveci/Desktop/Code/alphafrontend/docs/excel/test.xlsx',
                    'test.xlsx'  // In case it's in the same directory
                ];
                
                let response = null;
                let successPath = null;
                
                for (const path of paths) {
                    appendOutput('Trying path: ' + path, 'log');
                    try {
                        response = await fetch(path);
                        if (response.ok) {
                            successPath = path;
                            break;
                        }
                    } catch (e) {
                        // Continue to next path
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error('Failed to load test file from any path. Please use the file input to select test.xlsx manually.');
                }
                
                appendOutput('‚úÖ Loaded from: ' + successPath, 'success');
                const blob = await response.blob();
                const file = new File([blob], 'test.xlsx', {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                
                processFile(file);
            } catch (error) {
                appendOutput('‚ùå Error loading test file: ' + error.message, 'error');
                appendOutput('Please select a file manually using the file input.', 'warning');
                appendOutput('You can browse to: /Users/mertdeveci/Desktop/Code/alphafrontend/docs/excel/test.xlsx', 'log');
            }
        }
        
        // Process the file
        function processFile(file) {
            try {
                appendOutput('\\n' + '='.repeat(60), 'log');
                appendOutput('üìä Processing file: ' + file.name, 'log');
                appendOutput('File size: ' + (file.size / 1024).toFixed(2) + ' KB', 'log');
                appendOutput('\\nStep 1: Importing to Univer format...', 'log');
                
                if (!window.LuckyExcel) {
                    throw new Error('LuckyExcel is not defined! Build may have failed.');
                }
                
                LuckyExcel.transformExcelToUniver(
                file,
                function(univerData) {
                    appendOutput('‚úÖ Import successful!\\n', 'success');
                    
                    // Analyze the data
                    analyzeWorkbook(univerData);
                    
                    // Now export it back
                    appendOutput('\\n' + '='.repeat(60), 'log');
                    appendOutput('Step 2: Exporting back to Excel...', 'log');
                    appendOutput('\\nüîç Monitoring formula processing (from debug logs):\\n', 'log');
                    
                    LuckyExcel.transformUniverToExcel({
                        snapshot: univerData,
                        fileName: 'export-test.xlsx',
                        success: function(buffer) {
                            appendOutput('\\n‚úÖ Export completed!', 'success');
                            
                            // Create download link
                            const blob = new Blob([buffer], {
                                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                            });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'export-test.xlsx';
                            
                            appendOutput('\\nüì• Download ready: ', 'log');
                            const downloadBtn = document.createElement('button');
                            downloadBtn.textContent = 'Download export-test.xlsx';
                            downloadBtn.onclick = () => a.click();
                            output.appendChild(downloadBtn);
                            
                            appendOutput('\\n‚ö†Ô∏è  IMPORTANT: Open the downloaded file in Excel and check for:', 'warning');
                            appendOutput('  1. Any corruption warnings from Excel', 'warning');
                            appendOutput('  2. Missing or altered formulas', 'warning');
                            appendOutput('  3. Specifically check sheet7 if it exists', 'warning');
                        },
                        error: function(err) {
                            appendOutput('\\n‚ùå Export failed: ' + err.message, 'error');
                            if (err.stack) {
                                appendOutput('Stack trace:\\n' + err.stack, 'error');
                            }
                        }
                    });
                },
                function(error) {
                    appendOutput('‚ùå Import failed: ' + error.message, 'error');
                    if (error.stack) {
                        appendOutput('Stack: ' + error.stack, 'error');
                    }
                }
            );
            } catch (error) {
                appendOutput('‚ùå Error in processFile: ' + error.message, 'error');
                if (error.stack) {
                    appendOutput('Stack: ' + error.stack, 'error');
                }
            }
        }
        
        function analyzeWorkbook(univerData) {
            appendOutput('üìä Workbook Analysis:', 'log');
            appendOutput('  Total sheets: ' + univerData.sheetOrder.length, 'log');
            
            let totalFormulas = 0;
            let totalSharedFormulas = 0;
            let problematicFormulas = [];
            
            univerData.sheetOrder.forEach((sheetId, index) => {
                const sheet = univerData.sheets[sheetId];
                const sheetInfo = analyzeSheet(sheet);
                
                appendOutput(`\\n  Sheet ${index + 1}: "${sheet.name}"`, 'log');
                appendOutput(`    Total formulas: ${sheetInfo.formulaCount}`, 'log');
                appendOutput(`    Shared formula cells: ${sheetInfo.sharedFormulaCount}`, 'log');
                appendOutput(`      - Master cells (si + f): ${sheetInfo.masterCells}`, 'log');
                appendOutput(`      - Dependent cells (si only): ${sheetInfo.dependentCells}`, 'log');
                
                if (sheetInfo.formulaTypes.size > 0) {
                    appendOutput(`    Formula types: ${Array.from(sheetInfo.formulaTypes).join(', ')}`, 'log');
                }
                
                if (sheetInfo.problematicFormulas.length > 0) {
                    appendOutput(`    ‚ö†Ô∏è Potentially problematic formulas: ${sheetInfo.problematicFormulas.length}`, 'warning');
                    sheetInfo.problematicFormulas.slice(0, 3).forEach(p => {
                        appendOutput(`      ${p.cell}: ${p.formula.substring(0, 50)}...`, 'formula');
                    });
                }
                
                if (sheet.arrayFormulas && sheet.arrayFormulas.length > 0) {
                    appendOutput(`    Array formulas: ${sheet.arrayFormulas.length}`, 'log');
                }
                
                totalFormulas += sheetInfo.formulaCount;
                totalSharedFormulas += sheetInfo.sharedFormulaCount;
                problematicFormulas = problematicFormulas.concat(sheetInfo.problematicFormulas);
            });
            
            appendOutput(`\\nüìà Summary:`, 'log');
            appendOutput(`  Total formulas across all sheets: ${totalFormulas}`, 'log');
            appendOutput(`  Total shared formula cells: ${totalSharedFormulas}`, 'log');
            
            if (problematicFormulas.length > 0) {
                appendOutput(`  ‚ö†Ô∏è Total problematic formulas: ${problematicFormulas.length}`, 'warning');
            }
        }
        
        function analyzeSheet(sheet) {
            let formulaCount = 0;
            let sharedFormulaCount = 0;
            let masterCells = 0;
            let dependentCells = 0;
            const formulaTypes = new Set();
            const problematicFormulas = [];
            
            if (sheet.cellData) {
                for (const row in sheet.cellData) {
                    for (const col in sheet.cellData[row]) {
                        const cell = sheet.cellData[row][col];
                        if (cell) {
                            if (cell.f) {
                                formulaCount++;
                                
                                // Extract formula function name
                                const match = cell.f.match(/^=?([A-Z]+)\\(/);
                                if (match) {
                                    formulaTypes.add(match[1]);
                                }
                                
                                // Check for potentially problematic formulas
                                if (cell.f.includes('TRANSPOSE') || 
                                    cell.f.includes('#') ||
                                    cell.f.includes('{') ||
                                    cell.f.includes('}') ||
                                    cell.f.includes('@') ||
                                    cell.f.includes('_xlfn')) {
                                    problematicFormulas.push({
                                        cell: `${String.fromCharCode(65 + parseInt(col))}${parseInt(row) + 1}`,
                                        formula: cell.f,
                                        hasSi: !!cell.si
                                    });
                                }
                            }
                            
                            if (cell.si) {
                                sharedFormulaCount++;
                                if (cell.f) {
                                    masterCells++;
                                } else {
                                    dependentCells++;
                                }
                            }
                        }
                    }
                }
            }
            
            return {
                formulaCount,
                sharedFormulaCount,
                masterCells,
                dependentCells,
                formulaTypes,
                problematicFormulas
            };
        }
        
        // Initial message
        appendOutput('üîç Export Debug Test Ready', 'log');
        appendOutput('Upload an Excel file or click "Load test.xlsx from alphafrontend" to begin.', 'log');
    </script>
</body>
</html>