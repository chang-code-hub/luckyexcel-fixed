<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Full Flow Test - Import to Export</title>
    <script src="./dist/luckyexcel.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>Full Flow Test - Import ‚Üí Univer ‚Üí Export</h1>
    <p>This test traces the complete flow to identify where issues occur</p>
    <input type="file" id="fileInput" accept=".xlsx" />
    <pre id="output"></pre>
    
    <script>
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                console.log('=== FULL FLOW TEST STARTING ===');
                let report = 'FULL FLOW TEST REPORT\n';
                report += '=====================\n\n';
                
                // First, read the original file with XLSX to get baseline
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const originalWb = XLSX.read(data, {type: 'array', cellStyles: true});
                    
                    console.log('Original file parsed with XLSX');
                    
                    // Check original for comparison
                    const originalDCF = originalWb.Sheets['DCF'];
                    let originalChecks = {
                        definedNames: originalWb.Workbook?.Names?.length || 0,
                        transposeFormula: originalDCF?.['T83']?.f || 'none',
                        borderCount: 0
                    };
                    
                    // Count cells with styles in original
                    for (let addr in originalDCF) {
                        if (addr[0] !== '!' && originalDCF[addr].s) {
                            originalChecks.borderCount++;
                        }
                    }
                    
                    report += 'ORIGINAL FILE (via XLSX.js):\n';
                    report += `  Defined names: ${originalChecks.definedNames}\n`;
                    report += `  T83 formula: ${originalChecks.transposeFormula}\n`;
                    report += `  Cells with styles: ${originalChecks.borderCount}\n\n`;
                    
                    // Now import with LuckyExcel
                    LuckyExcel.transformExcelToUniver(
                        file,
                        function(workbookData) {
                            console.log('‚úÖ Import complete!');
                            console.log('Full Univer data:', workbookData);
                            
                            report += 'AFTER IMPORT TO UNIVER:\n';
                            
                            // 1. Check defined names
                            let definedNamesCount = 0;
                            if (workbookData.namedRanges) {
                                definedNamesCount = Object.keys(workbookData.namedRanges).length;
                            } else if (workbookData.definedNames) {
                                definedNamesCount = workbookData.definedNames.length;
                            }
                            report += `  Defined names: ${definedNamesCount}\n`;
                            
                            // 2. Check DCF sheet
                            let dcfSheet = null;
                            for (let sheetId in workbookData.sheets) {
                                if (workbookData.sheets[sheetId].name === 'DCF') {
                                    dcfSheet = workbookData.sheets[sheetId];
                                    break;
                                }
                            }
                            
                            if (dcfSheet) {
                                // Check T83
                                const row82 = dcfSheet.cellData?.[82];
                                const t83 = row82?.[19]; // T83 is column 19
                                
                                report += `  T83 formula: ${t83?.f || 'none'}\n`;
                                report += `  T83 has si (array formula ID): ${!!t83?.si}\n`;
                                
                                // Check array formulas
                                report += `  Array formulas: ${dcfSheet.arrayFormulas?.length || 0}\n`;
                                if (dcfSheet.arrayFormulas) {
                                    const transposeCount = dcfSheet.arrayFormulas.filter(af => 
                                        af.formula?.toUpperCase().includes('TRANSPOSE')
                                    ).length;
                                    report += `  TRANSPOSE in array formulas: ${transposeCount}\n`;
                                }
                                
                                // Check borders/styles
                                let cellsWithStyles = 0;
                                let cellsWithBorderStyle = 0;
                                
                                for (let row in dcfSheet.cellData) {
                                    for (let col in dcfSheet.cellData[row]) {
                                        const cell = dcfSheet.cellData[row][col];
                                        if (cell.s) {
                                            cellsWithStyles++;
                                            
                                            // Check if style has border
                                            const style = typeof cell.s === 'object' ? cell.s : workbookData.styles?.[cell.s];
                                            if (style?.bd) {
                                                cellsWithBorderStyle++;
                                            }
                                        }
                                    }
                                }
                                
                                report += `  Cells with styles: ${cellsWithStyles}\n`;
                                report += `  Cells with border styles: ${cellsWithBorderStyle}\n`;
                            }
                            
                            // Export back to Excel
                            console.log('\n=== Starting export ===');
                            LuckyExcel.transformUniverToExcel({
                                snapshot: workbookData,
                                fileName: 'flow-test-export.xlsx',
                                success: function(buffer) {
                                    console.log('‚úÖ Export complete');
                                    
                                    // Check the exported file
                                    const exportedWb = XLSX.read(buffer, {type: 'array', cellStyles: true});
                                    const exportedDCF = exportedWb.Sheets['DCF'];
                                    
                                    report += '\nAFTER EXPORT FROM UNIVER:\n';
                                    report += `  Defined names: ${exportedWb.Workbook?.Names?.length || 0}\n`;
                                    report += `  T83 formula: ${exportedDCF?.['T83']?.f || 'none'}\n`;
                                    
                                    // Check if formula has @ when read back
                                    if (exportedDCF?.['T83']?.f?.includes('@')) {
                                        report += '  ‚ö†Ô∏è T83 contains @ symbol in XLSX read!\n';
                                    }
                                    
                                    // Count styled cells in export
                                    let exportStyleCount = 0;
                                    for (let addr in exportedDCF) {
                                        if (addr[0] !== '!' && exportedDCF[addr].s) {
                                            exportStyleCount++;
                                        }
                                    }
                                    report += `  Cells with styles: ${exportStyleCount}\n`;
                                    
                                    // Summary
                                    report += '\n=== SUMMARY ===\n';
                                    report += `Defined names: ${originalChecks.definedNames} ‚Üí ${definedNamesCount} ‚Üí ${exportedWb.Workbook?.Names?.length || 0}\n`;
                                    report += `T83 TRANSPOSE: ${originalChecks.transposeFormula.includes('TRANSPOSE')} ‚Üí ${t83?.f?.includes('TRANSPOSE')} ‚Üí ${exportedDCF?.['T83']?.f?.includes('TRANSPOSE')}\n`;
                                    report += `Cell styles: ${originalChecks.borderCount} ‚Üí ${cellsWithStyles} ‚Üí ${exportStyleCount}\n`;
                                    
                                    document.getElementById('output').textContent = report;
                                    
                                    // Create download link
                                    const blob = new Blob([buffer], { 
                                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                                    });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = 'flow-test-export.xlsx';
                                    a.textContent = 'üì• Download exported file';
                                    a.style.display = 'block';
                                    a.style.marginTop = '20px';
                                    document.body.appendChild(a);
                                },
                                error: function(err) {
                                    console.error('Export error:', err);
                                    report += '\n‚ùå Export failed: ' + err.message;
                                    document.getElementById('output').textContent = report;
                                }
                            });
                        },
                        function(err) {
                            console.error('Import error:', err);
                            report += '\n‚ùå Import failed: ' + err.message;
                            document.getElementById('output').textContent = report;
                        }
                    );
                };
                reader.readAsArrayBuffer(file);
            }
        });
    </script>
</body>
</html>