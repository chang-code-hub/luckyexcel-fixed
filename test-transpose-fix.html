<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test TRANSPOSE Fix</title>
    <script src="./dist/luckyexcel.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>Test TRANSPOSE Fix</h1>
    <p>Upload test.xlsx to check if TRANSPOSE formulas are exported correctly without @ symbols</p>
    <input type="file" id="fileInput" accept=".xlsx" />
    <pre id="output"></pre>
    
    <script>
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                console.log('=== Starting import ===');
                
                LuckyExcel.transformExcelToUniver(
                    file,
                    function(workbookData) {
                        console.log('‚úÖ Import complete!');
                        
                        // Find DCF sheet
                        let dcfSheet = null;
                        for (let sheetId in workbookData.sheets) {
                            if (workbookData.sheets[sheetId].name === 'DCF') {
                                dcfSheet = workbookData.sheets[sheetId];
                                break;
                            }
                        }
                        
                        if (!dcfSheet) {
                            console.log('‚ùå DCF sheet not found!');
                            return;
                        }
                        
                        console.log('‚úÖ Found DCF sheet');
                        
                        // Check if TRANSPOSE formulas are now in arrayFormulas
                        if (dcfSheet.arrayFormulas && dcfSheet.arrayFormulas.length > 0) {
                            console.log('‚úÖ Array formulas detected:', dcfSheet.arrayFormulas.length);
                            
                            // Check for TRANSPOSE formulas
                            const transposeFormulas = dcfSheet.arrayFormulas.filter(af => 
                                af.formula && af.formula.toUpperCase().includes('TRANSPOSE')
                            );
                            console.log('‚úÖ TRANSPOSE formulas found:', transposeFormulas.length);
                            
                            document.getElementById('output').textContent = 
                                'TRANSPOSE formulas detected as array formulas: ' + transposeFormulas.length + '\n\n' +
                                JSON.stringify(transposeFormulas.slice(0, 3), null, 2);
                        } else {
                            console.log('‚ö†Ô∏è No array formulas detected');
                            document.getElementById('output').textContent = 'No array formulas detected';
                        }
                        
                        // Check T83 specifically
                        const row82 = dcfSheet.cellData && dcfSheet.cellData[82];
                        if (row82 && row82[19]) { // T83
                            console.log('T83 cell data:', row82[19]);
                            if (row82[19].si) {
                                console.log('‚úÖ T83 has formula ID (si):', row82[19].si);
                            }
                        }
                        
                        // Now export
                        console.log('\n=== Starting export ===');
                        LuckyExcel.transformUniverToExcel({
                            snapshot: workbookData,
                            fileName: 'fixed-export.xlsx',
                            success: function(buffer) {
                                console.log('‚úÖ Export complete!');
                                
                                // Check the exported file
                                const workbook = XLSX.read(buffer, {type: 'array'});
                                const dcfSheet = workbook.Sheets['DCF'];
                                
                                if (dcfSheet) {
                                    console.log('\n=== Checking exported TRANSPOSE formulas ===');
                                    
                                    let hasAtSymbol = false;
                                    const results = [];
                                    
                                    // Check specific TRANSPOSE cells
                                    const checkCells = ['T83', 'W83', 'Z83', 'T84', 'T100'];
                                    for (let cell of checkCells) {
                                        if (dcfSheet[cell] && dcfSheet[cell].f) {
                                            const formula = dcfSheet[cell].f;
                                            const hasAt = formula.includes('@');
                                            results.push(`${cell}: ${formula} ${hasAt ? '‚ùå HAS @' : '‚úÖ NO @'}`);
                                            
                                            if (hasAt) {
                                                hasAtSymbol = true;
                                                console.log(`‚ùå ${cell} still has @ symbol: ${formula}`);
                                            } else {
                                                console.log(`‚úÖ ${cell} fixed: ${formula}`);
                                            }
                                        }
                                    }
                                    
                                    document.getElementById('output').textContent += 
                                        '\n\n=== EXPORT RESULTS ===\n' + results.join('\n') +
                                        '\n\n' + (hasAtSymbol ? '‚ùå STILL HAS @ SYMBOLS!' : '‚úÖ ALL @ SYMBOLS REMOVED!');
                                }
                                
                                // Create download link
                                const blob = new Blob([buffer], { 
                                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                                });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'fixed-export.xlsx';
                                a.textContent = 'üì• Download fixed export';
                                a.style.display = 'block';
                                a.style.marginTop = '20px';
                                a.style.padding = '10px';
                                a.style.backgroundColor = '#4CAF50';
                                a.style.color = 'white';
                                a.style.textDecoration = 'none';
                                a.style.borderRadius = '5px';
                                document.body.appendChild(a);
                            },
                            error: function(err) {
                                console.error('‚ùå Export error:', err);
                            }
                        });
                    },
                    function(err) {
                        console.error('‚ùå Import error:', err);
                    }
                );
            }
        });
    </script>
</body>
</html>