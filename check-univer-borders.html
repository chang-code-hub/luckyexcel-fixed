<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Check Univer Border Data</title>
    <script src="./dist/luckyexcel.umd.js"></script>
</head>
<body>
    <h1>Check How Borders are Stored in Univer</h1>
    <input type="file" id="fileInput" accept=".xlsx" />
    <pre id="output"></pre>
    
    <script>
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                console.log('Importing file to check border data...');
                
                LuckyExcel.transformExcelToUniver(
                    file,
                    function(univerData) {
                        console.log('âœ… Import complete');
                        console.log('Full Univer data:', univerData);
                        
                        let report = 'UNIVER BORDER DATA ANALYSIS\n';
                        report += '===========================\n\n';
                        
                        // 1. Check styles object
                        report += '1. STYLES OBJECT\n';
                        report += '----------------\n';
                        if (univerData.styles) {
                            const styleIds = Object.keys(univerData.styles);
                            report += `Total styles: ${styleIds.length}\n`;
                            
                            // Check how many styles have borders
                            let borderStyleCount = 0;
                            let sampleBorderStyle = null;
                            
                            for (let styleId of styleIds) {
                                const style = univerData.styles[styleId];
                                if (style && style.bd) {
                                    borderStyleCount++;
                                    if (!sampleBorderStyle) {
                                        sampleBorderStyle = {id: styleId, style: style};
                                    }
                                }
                            }
                            
                            report += `Styles with borders (bd property): ${borderStyleCount}\n`;
                            
                            if (sampleBorderStyle) {
                                report += '\nSample border style:\n';
                                report += JSON.stringify(sampleBorderStyle, null, 2).substring(0, 500) + '...\n';
                            }
                        } else {
                            report += 'No styles object found\n';
                        }
                        
                        // 2. Check a specific sheet for cells with borders
                        report += '\n2. DCF SHEET BORDER DATA\n';
                        report += '------------------------\n';
                        
                        let dcfSheet = null;
                        for (let sheetId in univerData.sheets) {
                            if (univerData.sheets[sheetId].name === 'DCF') {
                                dcfSheet = univerData.sheets[sheetId];
                                break;
                            }
                        }
                        
                        if (dcfSheet) {
                            let cellsWithStyle = 0;
                            let cellsWithBorderStyle = 0;
                            let sampleCellWithBorder = null;
                            
                            // Check first 20 rows
                            for (let row = 0; row < 20 && row < 100; row++) {
                                if (!dcfSheet.cellData || !dcfSheet.cellData[row]) continue;
                                
                                for (let col = 0; col < 20; col++) {
                                    const cell = dcfSheet.cellData[row][col];
                                    if (!cell) continue;
                                    
                                    if (cell.s) {
                                        cellsWithStyle++;
                                        
                                        // Check if style has border
                                        const style = typeof cell.s === 'string' ? 
                                            univerData.styles?.[cell.s] : cell.s;
                                        
                                        if (style && style.bd) {
                                            cellsWithBorderStyle++;
                                            if (!sampleCellWithBorder) {
                                                sampleCellWithBorder = {
                                                    row: row,
                                                    col: col,
                                                    cell: cell,
                                                    style: style
                                                };
                                            }
                                        }
                                    }
                                }
                            }
                            
                            report += `Cells with style (first 20x20): ${cellsWithStyle}\n`;
                            report += `Cells with border style: ${cellsWithBorderStyle}\n`;
                            
                            if (sampleCellWithBorder) {
                                report += '\nSample cell with border:\n';
                                report += `Location: Row ${sampleCellWithBorder.row}, Col ${sampleCellWithBorder.col}\n`;
                                report += 'Border data: ' + JSON.stringify(sampleCellWithBorder.style.bd, null, 2) + '\n';
                            }
                        }
                        
                        // 3. Check how borders are structured
                        report += '\n3. BORDER STRUCTURE\n';
                        report += '-------------------\n';
                        
                        if (univerData.styles) {
                            // Find a style with complete border info
                            for (let styleId in univerData.styles) {
                                const style = univerData.styles[styleId];
                                if (style && style.bd) {
                                    report += 'Border properties found:\n';
                                    const bd = style.bd;
                                    
                                    if (bd.t) report += '  - Top border (t)\n';
                                    if (bd.b) report += '  - Bottom border (b)\n';
                                    if (bd.l) report += '  - Left border (l)\n';
                                    if (bd.r) report += '  - Right border (r)\n';
                                    
                                    report += '\nFull border object structure:\n';
                                    report += JSON.stringify(bd, null, 2).substring(0, 800) + '\n';
                                    break;
                                }
                            }
                        }
                        
                        document.getElementById('output').textContent = report;
                        
                        // Also export to see what happens to borders
                        console.log('Now exporting to check border loss...');
                        LuckyExcel.transformUniverToExcel({
                            snapshot: univerData,
                            fileName: 'border-test-export.xlsx',
                            success: function(buffer) {
                                console.log('âœ… Export complete');
                                console.log('Check console for full analysis');
                                
                                // Create download link
                                const blob = new Blob([buffer], { 
                                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                                });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'border-test-export.xlsx';
                                a.textContent = 'ðŸ“¥ Download exported file (with border issues)';
                                a.style.display = 'block';
                                a.style.marginTop = '20px';
                                document.body.appendChild(a);
                            },
                            error: console.error
                        });
                    },
                    console.error
                );
            }
        });
    </script>
</body>
</html>