<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test All Fixes - Comprehensive</title>
    <script src="./dist/luckyexcel.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1400px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 10px 0; background: #4CAF50; color: white; border: none; cursor: pointer; }
        .section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; background: #f9f9f9; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>Comprehensive Test - All Fixes</h1>
    
    <button id="selectBtn">Select test.xlsx</button>
    <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
    
    <div id="results"></div>

    <script>
        const selectBtn = document.getElementById('selectBtn');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        
        selectBtn.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await runComprehensiveTest(file);
            }
        });
        
        async function runComprehensiveTest(file) {
            console.log('=== COMPREHENSIVE TEST STARTING ===');
            results.innerHTML = '<h2>Testing...</h2>';
            
            let html = '';
            const issues = [];
            
            try {
                // Step 1: Import to Univer
                console.log('Step 1: Importing to Univer...');
                const univerData = await new Promise((resolve, reject) => {
                    LuckyExcel.transformExcelToUniver(
                        file,
                        (data) => resolve(data),
                        (error) => reject(error)
                    );
                });
                
                console.log('Import complete. Univer data:', univerData);
                
                // Test 1: Check defined names
                html += '<div class="section">';
                html += '<h3>Test 1: Defined Names</h3>';
                
                let definedNames = null;
                let definedNamesCount = 0;
                
                // Check resources for defined names
                if (univerData.resources) {
                    const definedNameResource = univerData.resources.find(r => r.name === 'SHEET_DEFINED_NAME_PLUGIN');
                    if (definedNameResource) {
                        try {
                            definedNames = JSON.parse(definedNameResource.data);
                            definedNamesCount = Object.keys(definedNames).length;
                        } catch(e) {
                            console.error('Error parsing defined names:', e);
                        }
                    }
                }
                
                if (definedNamesCount > 0) {
                    html += `<p class="success">✅ Found ${definedNamesCount} defined names in resources</p>`;
                    html += '<pre>' + JSON.stringify(Object.keys(definedNames).slice(0, 5), null, 2) + '</pre>';
                } else {
                    html += `<p class="error">❌ No defined names found (should be ~10)</p>`;
                    issues.push('Defined names not imported');
                }
                html += '</div>';
                
                // Test 2: Check styles/borders
                html += '<div class="section">';
                html += '<h3>Test 2: Styles and Borders</h3>';
                
                let styleCount = 0;
                let borderStyleCount = 0;
                
                if (univerData.styles) {
                    styleCount = Object.keys(univerData.styles).length;
                    borderStyleCount = Object.values(univerData.styles).filter((s) => s && s.bd).length;
                    
                    if (styleCount > 0) {
                        html += `<p class="success">✅ Found ${styleCount} styles (${borderStyleCount} with borders)</p>`;
                        
                        // Show sample border
                        const sampleBorder = Object.values(univerData.styles).find(s => s && s.bd);
                        if (sampleBorder) {
                            html += '<p>Sample border style:</p>';
                            html += '<pre>' + JSON.stringify(sampleBorder.bd, null, 2) + '</pre>';
                        }
                    } else {
                        html += `<p class="error">❌ No styles found</p>`;
                        issues.push('Styles not collected');
                    }
                } else {
                    html += `<p class="error">❌ No styles object in Univer data</p>`;
                    issues.push('Styles registry missing');
                }
                html += '</div>';
                
                // Test 3: Check array formulas
                html += '<div class="section">';
                html += '<h3>Test 3: Array Formulas (TRANSPOSE)</h3>';
                
                let arrayFormulaCount = 0;
                let transposeCount = 0;
                
                for (let sheetId in univerData.sheets) {
                    const sheet = univerData.sheets[sheetId];
                    if (sheet.arrayFormulas) {
                        arrayFormulaCount += sheet.arrayFormulas.length;
                        transposeCount += sheet.arrayFormulas.filter(af => 
                            af.formula && af.formula.includes('TRANSPOSE')
                        ).length;
                    }
                }
                
                if (transposeCount > 0) {
                    html += `<p class="success">✅ Found ${transposeCount} TRANSPOSE formulas out of ${arrayFormulaCount} array formulas</p>`;
                } else {
                    html += `<p class="warning">⚠️ No TRANSPOSE formulas found in arrayFormulas</p>`;
                }
                html += '</div>';
                
                // Step 2: Export
                console.log('Step 2: Exporting from Univer...');
                html += '<div class="section">';
                html += '<h3>Export Test</h3>';
                
                const exportBuffer = await new Promise((resolve, reject) => {
                    LuckyExcel.transformUniverToExcel({
                        snapshot: univerData,
                        fileName: 'test-export.xlsx',
                        getBuffer: true,
                        success: (buffer) => resolve(buffer),
                        error: (err) => reject(err)
                    });
                });
                
                html += `<p>Export successful: ${exportBuffer.byteLength} bytes</p>`;
                
                // Analyze the export
                const zip = new JSZip();
                await zip.loadAsync(exportBuffer);
                
                // Check workbook.xml for defined names
                const workbookXml = await zip.file('xl/workbook.xml').async('string');
                const hasDefinedNames = workbookXml.includes('<definedNames>');
                
                // Check styles.xml for borders
                const stylesXml = await zip.file('xl/styles.xml').async('string');
                const bordersMatch = stylesXml.match(/<borders count="(\d+)">/);
                const borderCount = bordersMatch ? parseInt(bordersMatch[1]) : 0;
                
                // Check for TRANSPOSE formulas
                let hasTranspose = false;
                let hasArrayAttr = false;
                const worksheetFiles = Object.keys(zip.files).filter(f => f.match(/xl\/worksheets\/sheet\d+\.xml/));
                for (const sheetPath of worksheetFiles) {
                    const sheetXml = await zip.file(sheetPath).async('string');
                    if (sheetXml.includes('TRANSPOSE')) {
                        hasTranspose = true;
                        if (sheetXml.includes('t="array"')) {
                            hasArrayAttr = true;
                        }
                    }
                }
                
                html += '<table>';
                html += '<tr><th>Check</th><th>Result</th></tr>';
                html += `<tr><td>Defined names in export</td><td class="${hasDefinedNames ? 'success' : 'error'}">${hasDefinedNames ? '✅ Yes' : '❌ No'}</td></tr>`;
                html += `<tr><td>Border styles count</td><td class="${borderCount > 1 ? 'success' : 'error'}">${borderCount} ${borderCount > 1 ? '✅' : '❌'}</td></tr>`;
                html += `<tr><td>TRANSPOSE formulas</td><td class="${hasTranspose ? 'success' : 'error'}">${hasTranspose ? '✅ Found' : '❌ Not found'}</td></tr>`;
                html += `<tr><td>Array formula attributes</td><td class="${hasArrayAttr ? 'success' : 'error'}">${hasArrayAttr ? '✅ Has t="array"' : '❌ Missing'}</td></tr>`;
                html += '</table>';
                
                // Create download link
                const blob = new Blob([exportBuffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                const url = URL.createObjectURL(blob);
                html += `<p><a href="${url}" download="test-export.xlsx">Download Export File</a></p>`;
                
                html += '</div>';
                
                // Summary
                html += '<div class="section">';
                html += '<h3>Summary</h3>';
                
                if (issues.length === 0 && definedNamesCount > 0 && styleCount > 0 && borderCount > 1) {
                    html += '<p class="success">🎉 ALL TESTS PASSED!</p>';
                } else {
                    html += '<p class="error">Issues found:</p>';
                    html += '<ul>';
                    if (definedNamesCount === 0) html += '<li>Defined names not imported</li>';
                    if (styleCount === 0) html += '<li>Styles not collected</li>';
                    if (borderCount <= 1) html += '<li>Border styles not exported</li>';
                    if (!hasDefinedNames) html += '<li>Defined names not in export</li>';
                    if (!hasArrayAttr) html += '<li>Array formula attributes missing</li>';
                    html += '</ul>';
                }
                
                html += '</div>';
                
            } catch (error) {
                console.error('Test error:', error);
                html = `<div class="section error">Error: ${error.message}</div>`;
            }
            
            results.innerHTML = html;
            console.log('=== TEST COMPLETE ===');
        }
    </script>
</body>
</html>